services:
  # ==========================================
  # MyLocalPlace API - ALWAYS RUNNING
  # ==========================================
  mylocalplace-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: mylocalplace-api
    command: ["runserver"]
    ports:
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PYTHONUNBUFFERED=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PORT=8000
      - WORKERS=4
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - local-services-network
    restart: unless-stopped

  # ==========================================
  # SERVICES - Created but NOT started
  # ==========================================
  local-postgres:
    container_name: local-postgres
    extends:
      file: services/postgres.yml
      service: postgres
    env_file:
      - .env
    networks:
      - local-services-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["services"]

  local-dbadmin:
    container_name: local-dbadmin
    extends:
      file: services/postgres.yml
      service: dbadmin
    env_file:
      - .env
    networks:
      - local-services-network
    depends_on:
      local-postgres:
        condition: service_healthy
    profiles: ["services"]

  local-redis:
    container_name: local-redis
    extends:
      file: services/redis.yml
      service: cache
    env_file:
      - .env
    networks:
      - local-services-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["services"]

  local-rabbitmq:
    container_name: local-rabbitmq
    extends:
      file: services/rabbitmq.yml
      service: rabbitmq
    env_file:
      - .env
    networks:
      - local-services-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["services"]

  local-mongodb:
    container_name: local-mongodb
    extends:
      file: services/mongo.yml
      service: mongodb
    env_file:
      - .env
    networks:
      - local-services-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["services"]

  local-langflow:
    container_name: local-langflow
    extends:
      file: services/langflow.yml
      service: langflow
    env_file:
      - .env
    networks:
      - local-services-network
    depends_on:
      local-postgres:
        condition: service_healthy
    profiles: ["services"]

  local-ollama:
    container_name: local-ollama
    extends:
      file: services/ollama.yml
      service: ollama
    networks:
      - local-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles: ["services"]

  local-openwebui:
    container_name: local-openwebui
    extends:
      file: services/ollama.yml
      service: openWebUI
    env_file:
      - .env
    networks:
      - local-services-network
    depends_on:
      local-ollama:
        condition: service_healthy
    profiles: ["services"]

  local-jupyter:
    container_name: local-jupyter
    extends:
      file: services/jupyter.yml
      service: jupyter
    env_file:
      - .env
    networks:
      - local-services-network
    profiles: ["services"]

volumes:
  postgres_data:
  pgadmin_data:
  redis_data:
  rabbitmq_data:
  mongodb_data:
  langflow_data:
  ollama_data:
  openwebui_data:
  jupyter_workspace:

networks:
  local-services-network:
    driver: bridge
